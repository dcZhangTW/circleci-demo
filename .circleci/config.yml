version: 2.1
on-push-main: &on-push-main
  branches:
    only: /main/
  tags:
    ignore: /.*/

executors: 
  docker-node-executor:
    docker:
      - image: cimg/node:lts
jobs:
  test-commit:
    executor: docker-node-executor
    parallelism: 2
    steps:
      - checkout
      - run: mkdir ~/junit
      - run:
          name: rum test
          command: |
            npm install
            TEST=$(circleci tests glob "./__tests__/*.js" | circleci tests split --split-by=timings)
            npm run test $TEST
          environment:
            JEST_JUNIT_OUTPUT: junit.xml
      - run:
          command: cp junit.xml ~/junit/
          when: always
      - store_test_results:
          path: ~/junit
workflows:
  main:
    jobs:
      - test-commit:
          filters: *on-push-main

          